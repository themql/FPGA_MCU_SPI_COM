[en](./README.md) | [ç®€ä¸­](./README_cn.md)

# FPGA ä¸ MCU ç®€æ˜“spié€šä¿¡

## 0. Intro

æœ¬ä»“åº“å®ç°ä¸¤ç§åŸºäºSPIçš„FPGAä¸MCUé€šè®¯æ–¹å¼: ram-likeä¸æŒ‡ä»¤è§£æã€‚

ä¸¤ç§æ–¹å¼å‡é€šè¿‡ç‰¹å®šçš„SPIåè®®ï¼Œå®ç°å¯¹ç›®æ ‡å¯„å­˜å™¨çš„ä¿®æ”¹ï¼Œä»è€Œæ§åˆ¶ç›¸å…³çš„åŠŸèƒ½é€»è¾‘éƒ¨åˆ†ã€‚ä¸¤ç§æ–¹å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºé€šä¿¡åè®®çš„è®¾è®¡ä¸spiæ¥å£æ¨¡å—çš„å®ç°ä¸åŒã€‚ram-likeæ–¹å¼ä¸­ï¼Œä¸ºæ¯ä¸ªå¯è¢«è®¿é—®çš„å¯„å­˜å™¨åˆ†é…ç‹¬ç«‹åœ°å€ï¼Œé€šè¿‡åœ°å€æ¥è®¿é—®ä¸åŒçš„çš„å¯„å­˜å™¨;æŒ‡ä»¤è§£ææ–¹å¼ä¸­ï¼Œåˆ™æ˜¯è§£æç‰¹å®šçš„åè®®æŒ‡ä»¤æ¥æ“ä½œå¯„å­˜å™¨ï¼Œç›¸å…³çš„å¯„å­˜å™¨å¯¹MCUæ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚

æœ¬ä»“åº“åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œessentialä¸­ç”¨ä¸¤ç§æ–¹å¼å®ç°äº†åŸºæœ¬çš„è¯»å†™åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¯„å­˜å™¨çš„è¯»å†™ã€FIFOçš„è¯»å†™ä¸DPRAMçš„è¯»å†™ï¼ŒsimpleDSPä¸­ä½¿ç”¨ram-likeæ–¹å¼å®ç°äº†ç®€å•çš„æ•°å­—ä¿¡å·å¤„ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¿¡å·é‡‡æ ·ã€FFTä¸IFFTã€FIRæ»¤æ³¢ï¼ˆæœªå®Œæˆï¼‰ã€‚

â€‹å®éªŒä¸­ä½¿ç”¨äº†Intelçš„IPæ ¸ï¼Œå¹¶æä¾›ç›¸åº”çš„ä»¿çœŸï¼Œå…·ä½“çš„è½¯ç¡¬ä»¶å¹³å°å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚



| å¹³å°           |                 |
| ------------ |:--------------- |
| FPGA         | EP4CE15         |
| MCU          | STM32F407       |
| **è½¯ä»¶**       |                 |
| Quartus (IP) | 18.1.1 Standard |
|              |                 |



## 1. ç›®å½•ç»“æ„

**æœ‰çš„æ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œæ˜¯è¿˜æ²¡åšå®Œã€‚**

```
FPGA_MCU_SPI_COM
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.assertÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â    // READMEä¸­å›¾åƒ
â”œâ”€â”€ README.md
â”œâ”€â”€ essential                       // åŸºç¡€éƒ¨åˆ†
â”‚Â Â  â”œâ”€â”€ alt_ip                      // ä½¿ç”¨åˆ°çš„IPæ ¸
â”‚Â Â  â”œâ”€â”€ Inst_pars                   // æŒ‡ä»¤è§£ææ–¹å¼
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ RTLÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // RTLå®ç°
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mcu_driver              // é©±åŠ¨ç¨‹åº
â”‚Â Â  â”‚Â Â  â””â”€â”€ sim
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ modelsim_prj
â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ run.do          // ä»¿çœŸè¿è¡Œè„šæœ¬
â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ wave.do         // æ³¢å½¢è„šæœ¬
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ run.bat             // å¯åŠ¨è„šæœ¬
â”‚Â Â  â”‚Â Â      â””â”€â”€ tb_main.v
â”‚Â Â  â””â”€â”€ sram_like                   // ç±»SRAMæ¥å£æ–¹å¼
â”‚      â”œâ”€sim
â”‚      â”œâ”€fsmc
â”‚      â”‚  â”œâ”€mcu_driver
â”‚      â”‚  â””â”€RTL
â”‚      â””â”€spi
â”‚          â”œâ”€mcu_driver
â”‚          â””â”€RTL
â””â”€â”€ simpleDSP                       // todo

```



## 2. spiæ¥å£

### 2.1. SPI

![](README.assert/SPI.jpg)

![](README.assert/wave_SPI.png)

SPIæ¨¡å—å®ç°äº†spiçš„ä»æœºæ¨¡å¼ï¼Œå¹¶ä¸”åªæ”¯æŒmode 0ï¼Œå³ä¸Šå‡æ²¿é‡‡æ ·ä¸‹é™æ²¿åˆ‡æ¢ã€‚é€šè¿‡å¯¹sclã€selç­‰ä¿¡å·çš„é‡‡æ ·ï¼Œåˆ¤æ–­å‡ºè¿™äº›ä¿¡å·çš„ä¸Šå‡ä¸‹é™æ²¿ï¼Œä½œå‡ºç›¸åº”çš„åŠ¨ä½œï¼Œå› æ­¤ï¼Œsclçš„æœ€å¤§é¢‘ç‡å—åˆ°clkçš„åˆ¶çº¦ã€‚ä¾‹å¦‚clkå–50Mï¼Œsclçš„é¢‘ç‡å°±ä¸èƒ½è¶…è¿‡25Mã€‚ç”±äºä»…ä½œä»æœºï¼ŒFPGAç«¯æ²¡æœ‰ä¸»åŠ¨å‘MCUå‘èµ·ä¼ è¾“çš„èƒ½åŠ›ï¼Œå½“MCUéœ€è¦è¯»å–æ•°æ®æ—¶ï¼Œéœ€è¦å‘é€ç©ºæ•°æ®äº§ç”Ÿsclæ—¶é’Ÿï¼Œå¾…è¯»å–çš„æ•°æ®æ‰èƒ½åœ¨sdoçº¿ï¼ˆFPGAç«¯ï¼Œå¯¹åº”MCUç«¯sdiçº¿ï¼‰ä¸Šå‡ºç°ã€‚

â€‹Data_beginä¸Data_endä¿¡å·ä½œä¸ºé€šè®¯çš„å¼€å§‹ä¸ç»“æŸæ ‡å¿—ï¼Œä¹Ÿæ˜¯Dinä¸Doutç«¯å£æ•°æ®çš„æœ‰æ•ˆæ ‡å¿—ã€‚åœ¨data_beginæ‹‰ä½å‰ï¼ŒDinç«¯å£å°±åº”å‡†å¤‡å¥½æ•°æ®ï¼Œå¦åˆ™Dinæ•°æ®æ— æ³•åŠæ—¶åœ°è¢«SPIæ¨¡å—è£…è½½ï¼Œsdoä¹Ÿå°±æ— æ³•æ­£ç¡®è¾“å‡ºã€‚åŒç†ï¼Œåœ¨Data_endæ‹‰é«˜å‰ï¼Œä¹Ÿä¸åº”è¯¥å»è¯»å–Doutç«¯å£çš„æ•°æ®ã€‚



### 2.2. ram-like

#### 2.2.1. æ€»æ¨¡å¼

![](README.assert/schema_ram_like.svg)

* spiæ¥å£æ¨¡å—ï¼ˆspi_ifï¼‰
  
  * è§£ææ¥æ”¶åˆ°çš„spiåè®®
  * å‘åæä¾›ç»Ÿä¸€çš„è¯»å†™æ¥å£ï¼ˆaddrã€wdataã€rdataã€wenã€renï¼‰

* ç”¨æˆ·å¯„å­˜å™¨æ¥å£æ¨¡å—ï¼ˆuser_regs_ifï¼‰
  
  * ç»Ÿä¸€ç®¡ç†éœ€è¦å¤–éƒ¨è®¿é—®çš„å¯„å­˜å™¨

* ç”¨æˆ·åŠŸèƒ½æ¨¡å—ï¼ˆuser_funcï¼‰
  
  * ä¸»ä½“åŠŸèƒ½å®ç°
    
    

#### 2.2.2. spi_ifä¸æŒ‡ä»¤ç»“æ„

![](README.assert/SPI_DCS.jpg)

é‡‡ç”¨ram-likeæ–¹å¼æ—¶ï¼Œspi_ifæ¨¡å—åœ¨åŸSPIçš„åŸºç¡€ä¸Šä¿®æ”¹ä¸ºåŒselçº¿spi_cs_addrä¸spi_cs_dataï¼Œä»¥åŒºåˆ«æœ¬æ¬¡ä¼ è¾“çš„æ•°æ®æ˜¯åœ°å€è¿˜æ˜¯æ•°æ®ã€‚æ¯æ¬¡ä¼ è¾“å®Œæ¯•ä¼šå°†åœ°å€æˆ–æ•°æ®å¯„å­˜ã€‚

æ¯æ¬¡MCUå‘èµ·ä¼ è¾“æ—¶ï¼Œå…ˆä¼ è¾“addrï¼Œå†³å®šæœ¬æ¬¡ä¼ è¾“ç±»å‹ï¼ˆè¯»/å†™ï¼‰ä¸ç›®æ ‡å¯„å­˜å™¨åœ°å€ï¼Œå†ä¼ è¾“dataï¼Œè¯»å‡ºæˆ–å†™å…¥æ•°æ®ã€‚addrçš„æœ€é«˜ä½å†³å®šäº†ä¼ è¾“ç±»å‹ï¼Œ0ä»£è¡¨å†™ä¼ è¾“ï¼Œ1ä»£è¡¨è¯»ä¼ è¾“ï¼Œä½™ä¸‹çš„ä½å‡ç”¨ä½œç›®æ ‡å¯„å­˜å™¨åœ°å€ã€‚ä¾‹å¦‚8ä½çš„addrï¼Œç¬¬8ä½å†³å®šä¼ è¾“ç±»å‹ï¼Œä½7ä½å†³å®šç›®æ ‡å¯„å­˜å™¨åœ°å€ã€‚

| å¯„å­˜å™¨åœ°å€ | addrï¼ˆ8ä½ï¼Œå†™æ“ä½œï¼‰ | addrï¼ˆ8ä½ï¼Œè¯»æ“ä½œï¼‰ |
| ----- | ------------ | ------------ |
| 6     | 0x06         | 0x86         |



### 2.3. æŒ‡ä»¤è§£æ

#### 2.3.1. æ€»æ¨¡å¼

![](README.assert/schema_ins_pars.svg)

* spiæ¥å£æ¨¡å—ï¼ˆspi_ifï¼‰
* æŒ‡ä»¤è§£ææ¥å£ï¼ˆins_pars_ifï¼‰
  * çŠ¶æ€æœºè§£ææŒ‡ä»¤
  * ç±»ä¼¼ç”¨æˆ·å¯„å­˜å™¨æ¥å£æ¨¡å—ï¼ˆuser_regs_ifï¼‰ï¼Œç»Ÿä¸€ç®¡ç†å¯„å­˜å™¨
* ç”¨æˆ·åŠŸèƒ½æ¨¡å—ï¼ˆuser_funcï¼‰
  * ä¸»ä½“åŠŸèƒ½å®ç°
    
    

#### 2.3.2. æŒ‡ä»¤ç»“æ„

æœ¬ç¤ºä¾‹ä¸­æŒ‡ä»¤è®¾è®¡åªè€ƒè™‘ç®€å•çš„åŸºæœ¬å®ç°ï¼Œæ— æ ¡éªŒç ç­‰è®¾è®¡ã€‚æŒ‡ä»¤ç”±è‹¥å¹²å­—èŠ‚æ„æˆï¼Œé¦–å­—èŠ‚å›ºå®šä¸ºæ“ä½œç ï¼ŒæŒ‡ç¤ºæœ¬æŒ‡ä»¤åŠŸèƒ½ï¼Œåæ¥è‹¥å¹²å­—èŠ‚ç”¨ä½œæŒ‡ä»¤ç›¸å…³å‚æ•°ã€‚

essentialéƒ¨åˆ†ä¸­æä¾›äº†ä¸€ä¸ªç®€å•ç¤ºä¾‹ã€‚



#### 2.3.3. çŠ¶æ€æœºè®¾è®¡

* Mooreå‹ä¸‰æ®µå¼çŠ¶æ€æœºï¼ˆçŠ¶æ€å¾ˆå¤šğŸ˜°ï¼‰
  
  * ï¼ˆåŸæœ¬é‡‡ç”¨Mealyå‹ï¼ŒçŠ¶æ€æ˜¯å°‘ç‚¹ï¼Œä½†æ›´åŠ å¤æ‚ï¼Œå¯è§commit /83315b0b /essential/Inst_pars/RTL/SPI_instPars_if.vï¼‰

* çŠ¶æ€æœºçš„è¾“å…¥ä¸ºSPIä¼ è¾“çš„å¼€å§‹ä¸ç»“æŸæ ‡å¿—ä¿¡å·ï¼ˆä¾‹å¦‚ï¼š`SPI_Data_begin`ä¸`SPI_Data_end`ï¼‰

![](README.assert/state_intro.svg)

* çŠ¶æ€å‘½åä¸€èˆ¬ä¸º`s_æ“ä½œç _çŠ¶æ€_wait`ä¸ `s_æ“ä½œç _çŠ¶æ€`ï¼Œå‰è€…ç”¨äºç­‰å¾…ä¼ è¾“ç»“æŸæ ‡å¿—çš„åˆ°æ¥ï¼Œåè€…åˆ™åœ¨ä¸€ä¸ªæ—¶é’Ÿå†…å®Œæˆç›¸åº”æ“ä½œï¼Œç„¶åè¿›å…¥ä¸‹ä¸€ä¸ªwaitçŠ¶æ€ã€‚

* å†™æ“ä½œä½¿ç”¨æ—¶åºé€»è¾‘ï¼Œè¯»æ“ä½œä½¿ç”¨ç»„åˆé€»è¾‘ã€‚æ³¨æ„ï¼Œå†™çš„æ—¶åºé€»è¾‘å’Œè¯»çš„ç»„åˆé€»è¾‘æ˜¯ä»¥**æ¬¡æ€**ä¸ºå‡†çš„ï¼Œå†™é€»è¾‘æ˜¯ä¸ºäº†é¿å…å¯„å­˜å™¨æ»åä¸€æ‹çš„å½±å“ï¼Œè¯»é€»è¾‘åˆ™æ˜¯å› ä¸ºSPIæ¨¡å—çš„è¯»æ“ä½œæ—¶åºååˆ†ä¸¥æ ¼ï¼Œå¦‚å‰æ‰€è¿°ï¼Œéœ€è¦åœ¨`Data_begin`ä¿¡å·æ‹‰ä½å‰å‡†å¤‡å¥½æ•°æ®ï¼Œè€Œ`Data_begin`ä¿¡å·ç”±åªæŒç»­ä¸€æ‹ã€‚çŠ¶æ€æœºä¸­ï¼Œæ˜¯ä»¥`Data_begin` ä¸ºä¾æ®è¿›å…¥è¯»å–çŠ¶æ€ï¼ˆä¸ºSPIæ¨¡å—æä¾›æ•°æ®çš„çŠ¶æ€ï¼Œ`s_*_readData`ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¦åœ¨è¿›å…¥è¯»å–çŠ¶æ€å‰å°±å°†æ•°æ®å‡†å¤‡å¥½ï¼Œæ‰€ä»¥è¦ä¾èµ–æ¬¡æ€ã€‚

* å…·ä½“ä¾‹å­å¯è§essentialéƒ¨åˆ†
  
  

### 2.4. ram-like vs æŒ‡ä»¤è§£æ

ram-likeæ–¹å¼æœ‰æå¼ºçš„æ‹“å±•æ€§ï¼Œå¯¹åº”ä¸åŒçš„åŠŸèƒ½éœ€æ±‚ï¼Œåªéœ€é‡å†™ç›¸å…³çš„å¯„å­˜å™¨æ¥å£å³å¯ï¼Œspiæ¥å£æ˜¯å¯ä»¥é€šç”¨çš„ã€‚ä¸å¼ºæ‹“å±•æ€§å¯¹åº”çš„æ˜¯æ•ˆç‡æ–¹é¢çš„æŸå¤±ï¼Œæ¯å½“è¦æ“ä½œä¸åŒçš„å¯„å­˜å™¨æ—¶ï¼Œéƒ½éœ€è¦é‡æ–°å‘èµ·ä¸€æ¬¡addrä¼ è¾“ã€‚å¯¹æ­¤ï¼Œä¸€ç§è§£å†³æ–¹å¼æ˜¯å¯ç”¨å¦ä¸€spiå¹¶æ·»åŠ ç›¸åº”çš„é€»è¾‘åŠŸèƒ½æ¥ä¸“é—¨ä¼ è¾“å¤„ç†å¤§æ‰¹é‡æ•°æ®ã€‚

æŒ‡ä»¤è§£ææ–¹å¼åˆ™å¼ºäºæ•ˆç‡ï¼Œä¸“ç”¨çš„æŒ‡ä»¤ä¿è¯äº†å¯„å­˜å™¨æ“ä½œçš„é«˜æ•ˆã€‚å¦ä¸€æ–¹é¢ï¼Œä¸“ç”¨çš„æŒ‡ä»¤ä¹Ÿå¯¼è‡´äº†ä¸å¯æ‹“å±•æ€§ä¸è§£ææ¨¡å—å¼€å‘çš„å¤æ‚æ€§ã€‚å¦‚æœFPGAèµ„æºå……è£•ï¼Œä½¿ç”¨è½¯æ ¸cpuå¯èƒ½æ˜¯ä¸ªæ›´åŠ æ–¹ä¾¿çš„é€‰æ‹©ã€‚



### 2.5. å…¶ä»–åè®®æ¥å£

#### 2.5.1. å¹¶å£ä¸fsmc

* å¹¶è¡Œä¼ è¾“åœ¨é€»è¾‘ä¸Šæ˜¯æ›´ç®€å•çš„ï¼Œæ— éœ€ç”¨åœ°å€åŒºåˆ†è¯»å†™ï¼Œå¯¹äºRAMä¹Ÿå¯ç›´æ¥è®¿é—®æ¯ä¸ªå•å…ƒã€‚å½“ç„¶æ•°æ®çº¿çš„å¢å¤šæ„å‘³ç€æ›´å¤æ‚çš„ç¡¬ä»¶è®¾è®¡éœ€æ±‚ã€‚

* fsmcé‡‡ç”¨SRAMä¼ è¾“åè®®ï¼ŒAæ¨¡å¼ï¼ˆOEç¿»è½¬ï¼Œåœ¨cubemxé…ç½®ä¸­æ‰“å¼€extended modeï¼‰ã€‚1æ¨¡å¼å¹¶æœªæµ‹è¯•ã€‚

* åè®®æ¥å£æ¨¡å—å°†å¼‚æ­¥çš„fsmcè½¬æ¢ä¸ºåŒæ­¥æ–¹å¼ï¼›ä¹Ÿå¯ä»¥ä¸ç»è¿‡åè®®æ¥å£æ¨¡å—ï¼Œç›´æ¥å¯¹å¯„å­˜å™¨å¼‚æ­¥è¯»å†™ï¼ˆregBank_async.vï¼‰ã€‚ï¼ˆRAMä¸FIFOçš„ipæ ¸ä»…æä¾›åŒæ­¥æ–¹å¼ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸æä¾›å¼‚æ­¥è¯»å†™æ–¹å¼ï¼‰
  
  

## 3. essential

### 3.1. å®ç°åŠŸèƒ½

* ç®€å•æ±‚å’Œ
  
  * æœ‰4ä¸ªç”¨æˆ·å¯„å­˜å™¨num1ã€num2ã€num3å’Œsumï¼Œsumä¸ºå‰ä¸‰è€…çš„å’Œã€‚

* dual clk FIFO
  
  * ä½¿ç”¨Intelçš„IPæ ¸ï¼Œé…ç½®å¤§å°ä¸º16ä½*256ï¼Œshow aheadæ¨¡å¼ã€‚

* dual port RAM
  
  * ä½¿ç”¨Intelçš„IPæ ¸ï¼Œé…ç½®å¤§å°ä¸º16ä½*256ï¼ŒåŒºåˆ†è¯»å†™æ—¶é’Ÿï¼Œè¯»ç«¯å£æ•°æ®ä¸éœ€è¦å¯„å­˜ã€‚

* ä½¿èƒ½æ§åˆ¶
  
  * å¯¹ä¸Šè¿°3ç‚¹åŠŸèƒ½æ·»åŠ ä½¿èƒ½æ§åˆ¶ã€‚



### 3.2. ram-like

#### 3.2.1. å¯„å­˜å™¨å®šä¹‰

| åœ°å€  | ç±»å‹  | ä½å®½  | åç§°                  | è¯´æ˜           |
| --- | --- | --- | ------------------- | ------------ |
| 0   | R   | 16  | sum                 |              |
| 1   | RW  | 16  | num1                |              |
| 2   | RW  | 16  | num2                |              |
| 3   | RW  | 16  | num3                |              |
| 4   | R/W | 16  | fifo_r/fifo_w       |              |
| 5   | W   | 8   | ram_waddr           |              |
| 6   | W   | 8   | ram_raddr           |              |
| 7   | R/W | 16  | ram_rdata/ram_wdata |              |
| 8   | RW  | 1   | ctrl                | ctrl[0] - en |
|     |     |     |                     |              |



* å¯„å­˜å™¨çš„ç±»å‹ä»£è¡¨å®ƒçš„è¯»å†™å±æ€§ï¼ŒR/Wä»£è¡¨å¯¹è¿™ä¸ªåœ°å€çš„è¯»å†™å®é™…ä¼šæ“ä½œä¸¤ä¸ªä¸åŒçš„å¯„å­˜å™¨ï¼Œæˆ–å®ç°ä¸åŒçš„åŠŸèƒ½ã€‚

* ä»¥fifoå’Œramä½œä¸ºå‰ç¼€çš„å¯„å­˜å™¨æ˜¯å¯¹ç›¸åº”æ“ä½œçš„å°è£…ï¼Œå¹¶ä¸ä¸€å®šä»£è¡¨çœŸæœ‰è¿™ä¸ªå¯„å­˜å™¨ã€‚

* å¯¹äºåœ°å€ä¸º4çš„å¯„å­˜å™¨ï¼Œå³FIFOçš„è¯»å†™æ“ä½œï¼Œå¯ä»¥è¿›è¡Œè¿ç»­å¤šæ¬¡çš„è¯»æˆ–å†™ã€‚

* å¯¹äºæ‰€æœ‰çš„å†™æ“ä½œï¼Œé‡‡ç”¨æ—¶åºé€»è¾‘ï¼›å¯¹äºæ‰€æœ‰çš„è¯»æ“ä½œï¼Œé‡‡ç”¨ç»„åˆé€»è¾‘ã€‚



### 3.3. æŒ‡ä»¤è§£æ

* spiä¼ è¾“ä½å®½ä¸º8ä½ï¼ŒFPGAä¸­æ•°æ®çš„ä½å®½ä½ä¸º16ä½ã€‚SPIæ¨¡å—ä¸ºæ ‡å‡†4çº¿SPIã€‚

* å¤šå­—èŠ‚æ•°æ®é»˜è®¤å°ç«¯åºï¼ˆä½å­—èŠ‚åœ¨å‰ï¼‰ã€‚ï¼ˆâš ä½†æ˜¯testbenché‡Œéœ€è¦è®¾ç½®æˆå¤§ç«¯åºï¼‰
  
  

#### 3.3.1. æŒ‡ä»¤è®¾è®¡

å…±8æ¡æŒ‡ä»¤ï¼š

| æŒ‡ä»¤æè¿°    | æ“ä½œç ï¼ˆé¦–å­—èŠ‚ï¼‰ |
| ------- | -------- |
| disable | 0x00     |
| enable  | 0x01     |

ç”¨äºç½®ä½æ§åˆ¶å¯„å­˜å™¨`ren`;



| æŒ‡ä»¤æè¿°           | æ“ä½œç ï¼ˆé¦–å­—èŠ‚ï¼‰ |         |           |           |
| -------------- | -------- | ------- | --------- | --------- |
| write register | 0x02     | regAddr | regData_0 | regData_1 |
| read register  | 0x03     | regAddr | 0x00      | 0x00      |

regAddrï¼Œå†…éƒ¨æ•°æ®å¯„å­˜å™¨ç¼–å€ã€‚

regData_0ï¼ŒregData_1ï¼Œå¤§å°ç«¯åºç”±parameter `isLittleEndian` å†³å®šã€‚



| æŒ‡ä»¤æè¿°       | æ“ä½œç ï¼ˆé¦–å­—èŠ‚ï¼‰ |           |           |         |         |     |         |         |
| ---------- | -------- | --------- | --------- | ------- | ------- | --- | ------- | ------- |
| write fifo | 0x04     | dataCnt_0 | dataCnt_1 | data0_0 | data0_1 | ... | dataX_0 | dataX_1 |
| read fifo  | 0x05     | dataCnt_0 | dataCnt_1 | 0x00    | 0x00    | ... | 0x00    | 0x00    |

FIFOè¯»å†™ï¼Œé‡‡ç”¨è¿ç»­ä¼ è¾“ã€‚

dataCntï¼Œ16ä½ï¼Œä¼ è¾“æ•°æ®çš„é•¿åº¦ã€‚

å½“FIFOæ»¡æ—¶ï¼Œå¤šä½™çš„æ•°æ®æ— æ•ˆï¼›FIFOç©ºæ—¶ï¼Œè¯»å‡º0ã€‚



| æŒ‡ä»¤æè¿°      | æ“ä½œç ï¼ˆé¦–å­—èŠ‚ï¼‰ |             |             |           |           |         |         |     |         |         |
| --------- | -------- | ----------- | ----------- | --------- | --------- | ------- | ------- | --- | ------- | ------- |
| write ram | 0x06     | firstAddr_0 | firstAddr_1 | dataCnt_0 | dataCnt_1 | data0_0 | data0_1 | ... | dataX_0 | dataX_1 |
| read ram  | 0x07     | firstAddr_0 | firstAddr_1 | dataCnt_0 | dataCnt_1 | 0x00    | 0x00    | ... | 0x00    | 0x00    |

RAMè¯»å†™ï¼Œé‡‡ç”¨è¿ç»­ä¼ è¾“ã€‚

firstAddrï¼Œ16ä½ï¼Œä¸ºæ•°æ®çš„é¦–åœ°å€ã€‚ï¼ˆramå¤§å°å…¶å®ä»…ä¸º16ä½*256ï¼Œ8ä½å¤Ÿäº†ï¼Œè®¾è®¡æˆ16ä½æ˜¯ä¸ºäº†é€šç”¨æ€§å¼ºç‚¹ï¼Œramæ·±åº¦å¤§ç‚¹æŒ‡ä»¤ä¹Ÿå¯ä»¥å…¼å®¹ï¼Œä½†æ— ç–‘æ˜¯ç‰ºç‰²äº†æ•ˆç‡çš„ï¼ˆä¸€èˆ¬éƒ½æ— æ‰€è°“ğŸ‘€ï¼‰ï¼‰

dataCntï¼Œ16ä½ï¼Œä¼ è¾“æ•°æ®çš„é•¿åº¦ã€‚

ä»é¦–åœ°å€å¼€å§‹é¡ºåºè¯»å†™ï¼Œå½“æ•°æ®å¯¹åº”çš„åœ°å€è¶…å‡ºRAMä¸Šé™æ—¶ï¼Œå†™å…¥æ— æ•ˆï¼Œè¯»å–ä¸º0ã€‚ï¼ˆåˆ¤æ–­ååˆ†ç®€é™‹ï¼Œ`fsm_addr_RAM >= RAM_SIZE` ï¼Œæº¢å‡ºä»€ä¹ˆçš„éƒ½æ²¡è€ƒè™‘ï¼‰



#### 3.3.2. æŒ‡ä»¤è§£æ FSM å›¾ç¤º
ä¸ºç®€åŒ–ï¼Œåœ¨åå‡ å¹…ç¤ºæ„å›¾ä¸­ï¼š

* æ¡ä»¶ä¸æ»¡è¶³æ—¶ç»´æŒåŸçŠ¶æ€çš„è·³è½¬ä¸æ˜¾ç¤º

* waitçŠ¶æ€ä¸æ˜¾ç¤ºï¼Œä»¥åœ¨å¯¹åº”çŠ¶æ€åæ·»åŠ  **(wait)** è¡¨ç¤ºã€‚

##### disable ä¸ enable

```mermaid
stateDiagram-v2
    s_idle      --> s_idle          
    s_idle      --> s_opDect        :transBegin

    s_opDect    --> s_opDect        
    s_opDect    --> s_disable/s_enable       :transEnd
Â Â Â Â 
    s_disable/s_enable   --> s_idle
```

##### write register

```mermaid
stateDiagram-v2      
    s_idle      --> s_opDect            : transBegin

    s_opDect    --> s_writeReg_getAddr_wait  : transEnd

    s_writeReg_getAddr_wait   --> s_writeReg_getAddr : transEnd

    s_writeReg_getAddr  --> s_writeReg_writeData_0_wait

    s_writeReg_writeData_0_wait --> s_writeReg_writeData_0 : transEnd

    s_writeReg_writeData_0 --> s_writeReg_writeData_1_wait

    s_writeReg_writeData_1_wait --> s_writeReg_writeData_1 : transEnd

    s_writeReg_writeData_1 --> s_idle
```

##### read register

```mermaid
stateDiagram-v2

s_idle --> s_opDect : transBegin

s_opDect --> s_readReg_getAddr_wait : transEnd

s_readReg_getAddr_wait --> s_readReg_getAddr : transEnd

s_readReg_getAddr --> s_readReg_readData_0 : transBegin

s_readReg_readData_0 --> s_readReg_readData_0_wait

s_readReg_readData_0_wait --> s_readReg_readData_1 : transBegin

s_readReg_readData_1 --> s_readReg_readData_1_wait

s_readReg_readData_1_wait --> s_idle : transEnd
```

##### write fifo ä¸ read fifo

```mermaid
stateDiagram-v2         
    s_idle      --> s_opDect        : transBegin

    s_opDect    --> s_writeFIFO_getCNT_0/1(wait) : transEnd

    s_writeFIFO_getCNT_0/1(wait) --> s_writeFIFO_keepWrite : transEnd

    s_writeFIFO_keepWrite --> s_writeFIFO_writeData_0(wait)

    s_writeFIFO_writeData_0(wait) --> s_writeFIFO_writeData_1(wait) : transEnd

    s_writeFIFO_writeData_1(wait) --> s_writeFIFO_updateAndBranch : transEnd

    s_writeFIFO_updateAndBranch --> s_writeFIFO_keepWrite : transEnd && (fsm_cnt != 0)
    s_writeFIFO_updateAndBranch --> s_idle : transEnd && (fsm_cnt == 0)
```

`fsm_cnt_FIFO` çš„è‡ªå‡ç”±åŸºäºæ¬¡æ€çš„æ—¶åºé€»è¾‘å®ç°ï¼Œç°æ€è·³è½¬åˆ° `s_writeFIFO_updateAndBranch` æ—¶å…¶å€¼å·²ç»å®Œæˆè‡ªå‡ï¼Œå³**å…ˆè‡ªå‡å†åˆ¤æ–­**ï¼Œæ‰€ä»¥å€¼å˜ä¸º0æ—¶è¯´æ˜æ‰€æœ‰æ•°æ®å·²ä¼ è¾“å®Œæˆã€‚

##### write ram ä¸ read ram

```mermaid
stateDiagram        
    s_idle      --> s_opDect        : transBegin

    s_opDect    --> s_writeRAM_getFirstAddr_0/1(wait) : transEnd

    s_writeRAM_getFirstAddr_0/1(wait) --> s_writeRAM_getCNT_0/1(wait) : transEnd

    s_writeRAM_getCNT_0/1(wait) --> s_writeRAM_setAddr : transEnd

    s_writeRAM_setAddr --> s_writeRAM_writeData_0(wait)

    s_writeRAM_writeData_0(wait) --> s_writeRAM_writeData_1(wait) : transEnd

    s_writeRAM_writeData_1(wait) --> s_writeRAM_updateAndBranch : transEnd

    s_writeRAM_updateAndBranch  --> s_writeRAM_setAddr   : transEnd && (fsm_cnt != 0)
    s_writeRAM_updateAndBranch  --> s_idle               : transEnd && (fsm_cnt == 0)
```

## 4. simpleDSP

ç”»ä¸ªé¥¼å…ˆ

### 4.1. ç»“æ„æ¡†å›¾

![](README.assert/diagram_simpleDSP.svg)

### 4.2. å¯„å­˜å™¨å®šä¹‰

| åœ°å€  | è¯»å†™  | å¯„å­˜å™¨å      |
| --- | --- | --------- |
| 0   | RW  | ctrl[9:0] |

* [0] en_sclkGen

* [1] en_sample

* [2] en_waveGen

* [3] en_FIR

* [4] wen_sclkGen_coef
  ç³»æ•°å†™ä½¿èƒ½ï¼Œå†™ä½¿èƒ½æœ‰æ•ˆæ—¶å¯¹åº”æ¨¡å—å¤±èƒ½ï¼ˆæ¨¡å—ä½¿èƒ½ = en_æ¨¡å— & (~ wen_æ¨¡å—ç³»æ•°)ï¼‰ã€‚

* [5] wen_FIR_coef
  ç³»æ•°å†™ä½¿èƒ½ï¼ŒåŒä¸Šã€‚

* [7:6] mode_sample
  
  * 0ï¼šè¿ç»­é‡‡æ ·ï¼Œä»…è¾“å‡ºåˆ°FIR
  * 1ï¼šçªå‘é‡‡æ ·(1024ç‚¹)ï¼Œä»…è¾“å‡ºåˆ°RAM
  * 2ï¼šçªå‘é‡‡æ ·(1024ç‚¹)ï¼Œä»…è¾“å‡ºåˆ°FIFO
  * 3ï¼šçªå‘é‡‡æ ·(1024ç‚¹)ï¼Œä»…è¾“å‡ºåˆ°RAMä¸FIFO

* [8] sel_FIR_WaveGen

* [9] en_intï¼šä¸­æ–­ä½¿èƒ½

| åœ°å€  | è¯»å†™  | å¯„å­˜å™¨å         |
| --- | --- | ------------ |
| 1   | W   | trigger[2:0] |

* [0] trig_sampleï¼š ç½®1è§¦å‘ä¸€æ¬¡é‡‡æ ·(1024ç‚¹)ï¼Œé‡‡æ ·ç»“æŸè‡ªåŠ¨ç½®0
* [1] trig_FFTï¼š    ç½®1è§¦å‘ä¸€æ¬¡è½¬æ¢(1024ç‚¹)ï¼Œè½¬æ¢ç»“æŸè‡ªåŠ¨ç½®0
* [2] trig_IFFTï¼š   ç½®1è§¦å‘ä¸€æ¬¡è½¬æ¢(1024ç‚¹)ï¼Œè½¬æ¢ç»“æŸè‡ªåŠ¨ç½®0

| åœ°å€  | è¯»å†™  | å¯„å­˜å™¨å       |
| --- | --- | ---------- |
| 1   | R   | state[2:0] |

* [0] busy_sample
* [1] busy_FFT
* [2] busy_IFFT

| åœ°å€  | è¯»å†™  | å¯„å­˜å™¨å            |
| --- | --- | --------------- |
| 2   | R   | fifo_wave_rdata |
|     | W   | fifo_wave_wdata |
| 3   | W   | ram_wave_waddr  |
| 4   | W   | ram_wave_raddr  |
| 5   | R   | ram_wave_rdata  |
|     | W   | ram_wave_wdata  |
| 6   | W   | ram_fre_waddr   |
| 7   | W   | ram_fre_raddr   |
| 8   | R   | ram_fre_rdata   |
|     | W   | ram_fre_wdata   |
| 9   | W   | FIRcoef_waddr   |
| 10  | W   | FIRcoef_raddr   |
| 11  | R   | FIRcoef_rdata   |
|     | W   | FIRcoef_wdata   |

| åœ°å€  | è¯»å†™  | å¯„å­˜å™¨å                 |
| --- | --- | -------------------- |
| 12  | RW  | sclk_gen_coef[31:16] |
| 13  | RW  | sclk_gen_coef[15:0]  |

sclk_gen_coefï¼šé‡‡æ ·æ—¶é’Ÿç”Ÿæˆç³»æ•°ï¼Œç±»ä¼¼DDSé¢‘ç‡æ§åˆ¶å­—

## 5. todo

1. ç°åœ¨åªè¿›è¡Œäº†ä»¿çœŸï¼Œè¿˜æœªå®é™…ä¸Šæ¿éªŒçœŸã€‚mcué©±åŠ¨ä¹Ÿæœªæµ‹è¯•ã€‚ï¼ˆæ‰€ä»¥ä»…ä¾›å‚è€ƒï¼ˆé€ƒï¼‰
2. simpleDSPï¼ˆæœ‰ç”Ÿä¹‹å¹´ï¼Œç­‰ ~~22~~ï¼‰
